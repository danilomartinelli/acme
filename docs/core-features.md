# Core Platform Features

## Overview

### Vis√£o

Capsule √© a plataforma que transforma monorepos Nx em aplica√ß√µes production-ready com um √∫nico comando. Assim como a Vercel revolucionou o deploy de aplica√ß√µes Next.js, Capsule faz o mesmo para arquiteturas empresariais complexas - detectando automaticamente microservi√ßos, frontends e workers em seu monorepo, configurando toda a infraestrutura necess√°ria (service mesh, brokers, observability) e deployando com configura√ß√£o zero.

**Nossa promessa**: Do c√≥digo ao production em menos de 5 minutos, sem YAML, sem Kubernetes, sem dor de cabe√ßa.

### O Problema Real

### Para Desenvolvedores e Startups

- **Complexidade desnecess√°ria**: Configurar Kubernetes, service mesh, observability e CI/CD pode levar semanas
- **Curva de aprendizado brutal**: Dezenas de ferramentas e conceitos antes do primeiro deploy
- **Custos imprevis√≠veis**: Overprovisioning por medo, surpresas na fatura da cloud
- **DevOps como gargalo**: Pequenos times gastam 40% do tempo em infraestrutura

### Para Empresas em Crescimento

- **Migra√ß√£o dolorosa**: Sair de PaaS simples (Heroku/Render) para arquitetura robusta √© um salto mortal
- **Vendor lock-in**: Presos em solu√ß√µes propriet√°rias sem path de sa√≠da
- **Falta de padroniza√ß√£o**: Cada time reinventa a roda, configura√ß√µes divergentes
- **Observability fragmentada**: Logs, m√©tricas e traces em ferramentas separadas

### Por que agora?

1. **Monorepos s√£o o novo padr√£o**: Nx, Turborepo e Rush dominam empresas modernas
2. **Microservi√ßos sem a complexidade**: Teams querem os benef√≠cios sem o overhead operacional
3. **FinOps √© cr√≠tico**: Press√£o por efici√™ncia de custos p√≥s-2023
4. **Developer Experience venceu**: Ferramentas que n√£o s√£o delightful morrem

### P√∫blico-alvo Prim√°rio

### 1. Early Adopters (MVP1)

- **Startup CTOs/Tech Leads** (50-200 funcion√°rios)
  - Usando Nx/monorepo mas sofrendo com deploy
  - Gastando $5k-50k/m√™s em cloud
  - Time de 5-20 devs, 0-2 DevOps

### 2. Expans√£o (MVP2)

- **Scale-ups** (200-1000 funcion√°rios)
  - Migrando de Heroku/Render para arquitetura pr√≥pria
  - Multiple squads, precisam de isolamento
  - Compliance e auditoria come√ßando a importar

### 3. Enterprise (MVP3)

- **Empresas estabelecidas** com iniciativas de moderniza√ß√£o
  - Querem alternativa ao EKS/GKE gerenciado
  - Precisam de exit strategy (export para K8s)
  - Multi-cloud e hybrid cloud requirements

### M√©tricas de Sucesso do Produto

### Ativa√ß√£o (Primeiras 4 semanas)

- **Time to First Deploy**: < 5 minutos (p50), < 10 minutos (p90)
- **Zero-config success rate**: > 80% dos monorepos Nx deployam sem configura√ß√£o manual
- **Ativa√ß√£o D7**: > 60% dos trials fazem 5+ deploys na primeira semana

### Engajamento (M√™s 2-3)

- **Weekly Active Teams**: > 70% dos times ativos semanalmente
- **Services per Account**: m√©dia de 5+ servi√ßos por conta ativa
- **Preview Environments**: > 50% dos PRs com preview autom√°tico

### Reten√ß√£o (Trimestre)

- **3-month retention**: > 85% das contas pagas
- **Revenue expansion**: > 140% NRR (net revenue retention)
- **Churn < 3% mensal** para contas > $500/m√™s

### North Star Metrics

- **Deploys per Developer per Week**: > 10 (vs. 2-3 industry average)
- **MTTR (Mean Time to Recovery)**: < 10 minutos com rollback autom√°tico
- **Infrastructure Cost Efficiency**: 30% redu√ß√£o vs. self-managed K8s

## Core Features Expandidas

### 0. ü™Ñ Magic Deploy para Monorepos Nx (Hero Feature - MVP1)

**Descri√ß√£o**

Deploy autom√°tico e inteligente de monorepos Nx com detec√ß√£o de arquitetura, igual Vercel faz com Next.js. Capsule analisa seu `nx.json`, detecta todos os apps (React, Angular, Vue, NestJS, Express), entende as depend√™ncias entre eles, e faz o deploy de tudo com configura√ß√£o zero.

**Como funciona a m√°gica**

1. **Connect GitHub**: Autoriza o repo
2. **Auto-discovery**: Capsule escaneia e encontra:
   - Frontend apps ‚Üí gera URLs p√∫blicas com CDN
   - API/Backend services ‚Üí configura API Gateway
   - Workers/Jobs ‚Üí setup de filas autom√°tico
   - Shared libs ‚Üí otimiza√ß√£o de build
3. **Smart Routing**: Cria rotas autom√°ticas baseadas em nomes
   - `apps/web` ‚Üí [`myapp.capsule.dev`](http://myapp.capsule.dev)
   - `apps/api` ‚Üí [`api.myapp.capsule.dev`](http://api.myapp.capsule.dev)
   - `apps/admin` ‚Üí [`admin.myapp.capsule.dev`](http://admin.myapp.capsule.dev)
4. **Instant Deploy**: Um clique, tudo no ar

**Acceptance Criteria**

- GIVEN um monorepo Nx com 5+ apps; WHEN conectado ao GitHub; THEN Capsule detecta todos os apps e suas depend√™ncias em < 30s
- GIVEN apps com `project.json` padr√£o; WHEN deploy √© triggered; THEN todos sobem com URLs funcionais em < 3 minutos
- GIVEN depend√™ncias entre apps; WHEN um lib compartilhada muda; THEN apenas apps afetados s√£o redeployados

**Magic Features Inclu√≠das**

- **Build Cache Inteligente**: Compartilha cache entre builds como Nx Cloud
- **Affected Detection**: S√≥ rebuilda o que mudou
- **Environment Sync**: Desenvolvimento, staging e production auto-configurados
- **Secrets Inference**: Detecta vari√°veis necess√°rias analisando imports

**Exemplos de Detec√ß√£o Autom√°tica**

```tsx
// Detectado: Frontend React com Vite
apps/portal/
  vite.config.ts    ‚Üí Deploy como SPA com CDN
  .env.example      ‚Üí Solicita vari√°veis no primeiro deploy

// Detectado: API NestJS
apps/api/
  main.ts com NestFactory ‚Üí Deploy como container, health check autom√°tico
  prisma/schema     ‚Üí Sugere database connection string

// Detectado: Worker/Cron
apps/worker/
  Bull/BullMQ imports ‚Üí Provisiona Redis automaticamente
  @Cron decorators   ‚Üí Configura agendamento
```

**KRs mensur√°veis**

- 90% dos monorepos Nx deployam sem nenhuma configura√ß√£o manual
- Tempo do push ao deploy < 3min (p50) para affected apps
- Zero-downtime em 100% dos deploys de atualiza√ß√£o

## Core Features

### 1. Deploy one-click para container images

**Descri√ß√£o**

Deploy via UI/CLI de imagens Docker p√∫blicas/privadas com health checks, rollout seguro e logs em tempo real.

**Owner sugerido**

Platform

**Prioridade / Esfor√ßo**

Alta / Baixo

**Registries suportados**

Docker Hub, Amazon ECR, GitHub Container Registry (GHCR) e registries privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN uma conta com permiss√µes v√°lidas e uma imagem dispon√≠vel no registry; WHEN o usu√°rio aciona "Deploy" via UI/CLI; THEN o servi√ßo sobe saud√°vel e fica acess√≠vel com logs e status em tempo real
- GIVEN uma imagem multi-arch; WHEN o deploy √© iniciado; THEN a arquitetura correta √© selecionada automaticamente
- GIVEN health checks configurados; WHEN o servi√ßo starta; THEN probes passam e o status muda para Healthy

**KRs mensur√°veis**

p50 de deploy < 60s; taxa de deploy bem-sucedido > 99% em imagens ‚â§ 500MB; falhas recuper√°veis com retry autom√°tico < 2 minutos

**Hip√≥teses de sucesso**

Simplificar o caminho da imagem √† produ√ß√£o reduz churn no onboarding e aumenta a ativa√ß√£o de contas

### 2. Blue/Green e Canary autom√°ticos por rota

**Descri√ß√£o**

Tr√°fego rote√°vel por porcentagem/rota com promo√ß√£o e rollback instant√¢neo.

**Owner sugerido**

Platform

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN uma vers√£o est√°vel (blue) e uma candidata (green); WHEN o usu√°rio configura 10% canary; THEN 10% do tr√°fego √© roteado para green e m√©tricas s√£o coletadas
- GIVEN degrada√ß√£o de m√©tricas; WHEN limiares s√£o ultrapassados; THEN rollback autom√°tico ocorre em < 30s
- GIVEN m√∫ltiplas rotas; WHEN se define pesos por rota; THEN a distribui√ß√£o respeita as porcentagens por rota

**KRs mensur√°veis**

95% de rollbacks autom√°ticos em canaries problem√°ticos; tempo de rollback < 30s p50; zero downtime percept√≠vel (erro 5xx adicional < 0,1%)

**Hip√≥teses de sucesso**

Releases graduais reduzem risco e aumentam velocidade de entrega sem impactar usu√°rios

### 3. Service Discovery + Internal DNS leve

**Descri√ß√£o**

Resolu√ß√£o DNS interna (svc.internal) com pol√≠ticas de acesso e mTLS opcional, suportando HTTP/gRPC/broker.

**Owner sugerido**

Infra

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN dois servi√ßos no mesmo app; WHEN um chama outro via nome DNS interno; THEN a resolu√ß√£o ocorre < 100ms e respeita pol√≠ticas de rede
- GIVEN mTLS habilitado; WHEN servi√ßos se comunicam; THEN certificados v√°lidos s√£o negociados e conex√µes n√£o autorizadas s√£o bloqueadas
- GIVEN namespaces l√≥gicos; WHEN pol√≠ticas s√£o aplicadas; THEN isolamento entre ambientes √© garantido

**KRs mensur√°veis**

Resolu√ß√£o p95 < 100ms; 0 conex√µes cross-namespace n√£o autorizadas; 100% de rota√ß√£o de certificados automatizada

**Hip√≥teses de sucesso**

Descoberta simples diminui erros de configura√ß√£o e incidentes de rede

### 4. Managed Broker Marketplace (RabbitMQ/Redis pub/sub)

**Descri√ß√£o**

Provisionamento on-demand com isolamento por tenant, rotas seguras e quotas/retention configur√°veis.

**Owner sugerido**

Infra

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN um projeto; WHEN o usu√°rio provisiona um broker; THEN endpoints e credenciais seguras s√£o entregues em < 3 minutos
- GIVEN bindings definidos; WHEN servi√ßos sobem; THEN conex√µes TLS s√£o estabelecidas e quotas aplicadas
- GIVEN upgrade de plano; WHEN ampliado; THEN interrup√ß√£o m√°xima < 30s

**KRs mensur√°veis**

Provisionamento p90 < 3min; isolamento multi-tenant sem vazamentos (0 incidentes); > 99,9% uptime trimestral

**Hip√≥teses de sucesso**

Broker gerenciado reduz configura√ß√£o e acelera ado√ß√£o de arquiteturas event-driven

### 5. Config & Secrets as Code

**Descri√ß√£o**

Configura√ß√£o declarativa e integra√ß√£o com Vault-compatible para inje√ß√£o segura via env/volume.

**Owner sugerido**

Platform

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN secrets referenciados; WHEN um deploy roda; THEN secrets s√£o injetados sem exposi√ß√£o em logs
- GIVEN um PR com altera√ß√£o em config; WHEN aplicado; THEN hist√≥rico e diff s√£o registr√°veis e audit√°veis
- GIVEN rota√ß√£o de secret; WHEN atualizada; THEN servi√ßos recebem novos valores sem downtime

**KRs mensur√°veis**

100% de opera√ß√µes de secrets auditadas; rota√ß√£o de secrets em < 5min; zero vazamento de segredos em logs conhecidos

**Hip√≥teses de sucesso**

Declaratividade e auditoria elevam confian√ßa e conformidade

### 6. Built-in Observability Minimal

**Descri√ß√£o**

Logs agregados, traces com sampling e m√©tricas b√°sicas (lat√™ncia/throughput), export√°veis via OTLP/Prometheus.

**Owner sugerido**

Infra

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN um servi√ßo; WHEN filtros de logs s√£o aplicados; THEN busca retorna em < 2s p50
- GIVEN tracing habilitado; WHEN requests fluem; THEN spans e lat√™ncias s√£o visualiz√°veis por servi√ßo
- GIVEN m√©tricas padr√£o; WHEN dashboards s√£o abertos; THEN p95/p99 e erro rate s√£o exibidos por rota

**KRs mensur√°veis**

Consulta de logs p50 < 2s; 100% de servi√ßos com m√©tricas b√°sicas; redu√ß√£o de MTTR em 30%

**Hip√≥teses de sucesso**

Visibilidade m√≠nima j√° reduz tempo de diagn√≥stico em incidentes comuns

### 7. Preview Environments autom√°ticos por branch/PR

**Descri√ß√£o**

Ambientes ef√™meros por PR/branch com teardown autom√°tico, links p√∫blicos e pol√≠ticas de custo.

**Owner sugerido**

Platform

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN um PR aberto; WHEN pipeline roda; THEN um ambiente preview √© criado em < 5min com URL p√∫blica
- GIVEN PR fechado/inativo; WHEN TTL expira; THEN preview √© destru√≠do automaticamente
- GIVEN limites de custo; WHEN excedidos; THEN preview √© pausado e alerta √© enviado

**KRs mensur√°veis**

80% dos PRs com preview; custo m√©dio por preview dentro de ¬±10% do or√ßamento; teardown autom√°tico em 100% dos expirados

**Hip√≥teses de sucesso**

Previews aceleram valida√ß√£o e reduzem regress√µes

### 8. Lightweight Autoscaling por service

**Descri√ß√£o**

Escalonamento por CPU/RPS/custom, com limites m√≠nimo/m√°ximo e cooldown.

**Owner sugerido**

Infra

**Prioridade / Esfor√ßo**

M√©dio / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN pol√≠ticas definidas; WHEN carga aumenta; THEN r√©plicas escalam sem thrashing
- GIVEN cooldown; WHEN picos transit√≥rios; THEN scaling n√£o oscila acima de ¬±1 r√©plica
- GIVEN limites; WHEN carga cai; THEN escala para o m√≠nimo respeitando SLOs

**KRs mensur√°veis**

Redu√ß√£o de 20% no custo m√©dio sem impacto no p95; ‚â§ 5% de eventos de thrashing por semana

**Hip√≥teses de sucesso**

Pol√≠ticas simples cobrem 80% dos casos sem mesh completo

### 9. Network Policies GUI + Templates

**Descri√ß√£o**

Editor visual com templates seguros para ingress/egress entre servi√ßos, HTTP/gRPC/broker.

**Owner sugerido**

Frontend

**Prioridade / Esfor√ßo**

M√©dio / Baixo

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN um servi√ßo; WHEN uma pol√≠tica √© aplicada via UI; THEN tr√°fego n√£o permitido √© bloqueado
- GIVEN presets; WHEN selecionados; THEN regras m√≠nimas seguras entram em vigor
- GIVEN valida√ß√£o; WHEN h√° conflito; THEN a UI exibe erro antes de aplicar

**KRs mensur√°veis**

90% das pol√≠ticas criadas via UI (sem YAML); redu√ß√£o de 50% de incidentes de egress indevido

**Hip√≥teses de sucesso**

Visualidade e presets reduzem erros e tempo de configura√ß√£o

### 10. Portable Export/Import (Infra as Code)

**Descri√ß√£o**

Exportar/importar app, roteamento e depend√™ncias em YAML/Helm/Terraform para reduzir lock-in.

**Owner sugerido**

Platform

**Prioridade / Esfor√ßo**

Alta / M√©dio

**Registries suportados**

Docker Hub, ECR, GHCR e privados via imagePullSecret

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN um app; WHEN exportado; THEN o bundle aplica em um Kubernetes vanilla sem ajustes manuais
- GIVEN um bundle; WHEN importado; THEN diferen√ßas s√£o mostradas (dry-run) e aplica√ß√£o √© idempotente
- GIVEN rotas/policies; WHEN exportadas; THEN sem√¢ntico √© preservado

**KRs mensur√°veis**

30% dos apps com export habilitado; 0 falhas conhecidas de import idempotente nos casos testados

**Hip√≥teses de sucesso**

Portabilidade aumenta confian√ßa e reduz risco de lock-in

### 11. Authentication & Authorization (RBAC)

**Descri√ß√£o**

Sistema completo de autentica√ß√£o multi-provider (OAuth + Email/Password), autoriza√ß√£o baseada em roles (RBAC), gest√£o de organiza√ß√µes/times e API Keys para automa√ß√£o.

**Owner sugerido**

Platform

**Prioridade / Esfor√ßo**

Alta / M√©dio (cr√≠tico para MVP1)

**Providers suportados**

- OAuth: GitHub, Google, GitLab
- Email/Password com verifica√ß√£o
- API Keys para CI/CD e automa√ß√£o
- SSO SAML para Enterprise (MVP3)

**Acceptance Criteria (GIVEN/WHEN/THEN)**

- GIVEN um novo usu√°rio; WHEN se registra via GitHub OAuth; THEN conta √© criada, organiza√ß√£o padr√£o provisionada e JWT emitido
- GIVEN um membro com role Developer; WHEN tenta deletar servi√ßo; THEN a√ß√£o √© negada com 403 Forbidden
- GIVEN uma API Key com permiss√µes limitadas; WHEN usada para deploy; THEN apenas a√ß√µes permitidas s√£o executadas
- GIVEN token expirado; WHEN refresh token √© v√°lido; THEN novo access token √© gerado sem re-login
- GIVEN convite para organiza√ß√£o; WHEN aceito; THEN usu√°rio √© adicionado com role especificado

**KRs mensur√°veis**

Tempo de login < 2s p50; Taxa de sucesso OAuth > 99%; Rota√ß√£o autom√°tica de tokens sem downtime; 100% das a√ß√µes audit√°veis

**Hip√≥teses de sucesso**

OAuth reduz atrito no onboarding; RBAC granular previne incidentes de seguran√ßa; API Keys habilitam automa√ß√£o segura

## User Experience

### Personas

- **Dev Solo**: busca velocidade e simplicidade
- **Founder/CTO**: foco em previsibilidade de custo e governan√ßa leve
- **Eng. Full-stack**: produtividade no dia a dia, CI/CD e depura√ß√£o

### Roles e permiss√µes (RBAC detalhado)

### Owner (Propriet√°rio)

- Acesso total √† organiza√ß√£o
- Gerencia billing e upgrades de plano
- Define pol√≠ticas globais e limites
- Gerencia membros e seus roles
- Deleta organiza√ß√£o
- Todas as permiss√µes de Admin

### Admin (Administrador)

- Cria/edita/deleta projetos e ambientes
- Gerencia membros (exceto outros admins/owner)
- Configura integra√ß√µes e webhooks
- Acessa logs de auditoria
- Todas as permiss√µes de Developer

### Developer (Desenvolvedor)

- Cria/edita servi√ßos
- Realiza deploys e rollbacks
- Gerencia secrets e configura√ß√µes
- Cria/deleta preview environments
- Visualiza logs, m√©tricas e traces
- Configura autoscaling e health checks

### Viewer (Visualizador)

- Acesso read-only a todos os recursos
- Visualiza servi√ßos e status
- Visualiza logs e m√©tricas
- Lista secrets (sem ver valores)
- Exporta relat√≥rios

### Regras de RBAC

- Permiss√µes s√£o hier√°rquicas (Owner > Admin > Developer > Viewer)
- Permiss√µes podem ser customizadas por projeto/ambiente
- API Keys herdam permiss√µes do criador ou podem ter escopo reduzido
- Audit log registra todas as a√ß√µes com timestamp e autor

### Alertas de cobran√ßa (UX)

- Banner n√£o intrusivo quando 70% do or√ßamento do m√™s √© atingido; toast e e-mail/SMS opcional
- Ao atingir 90%: modal com op√ß√µes (ajustar or√ßamento, pausar previews, reduzir autoscaling)
- P√°gina de custos com breakdown por servi√ßo/ambiente e previs√£o do m√™s

### User flows cr√≠ticos

### 1. Deploy one-click

**Passos (UI)**: Login ‚Üí Conectar registry ‚Üí Selecionar imagem (tag) ‚Üí Configurar env/health ‚Üí Confirmar Deploy ‚Üí Ver status/logs

**CLI**:

```bash
capsule registry add ...
capsule deploy --image [ghcr.io/org/api:1.0.0](http://ghcr.io/org/api:1.0.0) --env prod
```

**Telas**: Conex√£o de registry, Form de Deploy, Painel de Servi√ßo (status, logs)

### 2. Preview Environment por PR

**Passos (UI/CI)**: Abrir PR ‚Üí Pipeline chama `capsule preview create --branch feature-x` ‚Üí Link p√∫blico no PR ‚Üí QA valida ‚Üí Merge ‚Üí Auto-teardown

**Telas**: Lista de Previews, Detalhe do Preview (URL, status, TTL, custo estimado)

### 3. Rollout/Canary e rollback

**Passos (UI)**: Servi√ßo ‚Üí Nova vers√£o ‚Üí Definir % (ex.: 10%) ‚Üí Monitorar m√©tricas (p95, erro rate) ‚Üí Promover/rollback

**CLI**:

```bash
capsule canary start --service api --percent 10
capsule canary promote|rollback
```

**Telas**: Controle de Tr√°fego por Rota, Painel de M√©tricas por vers√£o

## Technical Architecture

### Diagrama l√≥gico descritivo

- Portal (Vite/React) ‚Üí API Gateway (BFF NestJS)
- API Gateway ‚Üí Control Plane (orquestra deploy/scale/rotas, gerencia estado declarativo)
- Control Plane ‚Üí Runners/Workers (executores de deploy, coleta de health/logs/metrics)
- Control Plane ‚Üí Managed Brokers (RabbitMQ/Redis) e integra√ß√µes externas (Vault, registries)
- Data Plane: servi√ßos do usu√°rio (pods/tasks) com sidecars opcionais (mesh-lite)
- External State: bancos de dados e storages gerenciados externos √† Capsule

### Diagrama Visual da Arquitetura

```mermaid
graph TB
    subgraph "Client Layer"
        Portal[Portal Web<br/>React + Vite]
        CLI[Capsule CLI]
        SDK[SDKs]
    end

    subgraph "API Layer"
        Gateway[API Gateway<br/>NestJS BFF]
    end

    subgraph "Control Plane"
        CP[Control Plane<br/>Orchestrator]
        Deploy[Deploy Service]
        Billing[Billing Service]
        Auth[Auth Service]
    end

    subgraph "Data Plane"
        Runner[Deploy Runners]
        Services[User Services<br/>Containers]
        Brokers[Managed Brokers<br/>RabbitMQ/Redis]
    end

    subgraph "Infrastructure"
        DB[(PostgreSQL)]
        Vault[HashiCorp Vault]
        Registry[Container Registry]
        Metrics[Prometheus/Grafana]
    end

    Portal --> Gateway
    CLI --> Gateway
    SDK --> Gateway

    Gateway --> CP
    Gateway --> Deploy
    Gateway --> Billing
    Gateway --> Auth

    CP --> Runner
    CP --> Brokers
    Runner --> Services

    CP --> DB
    CP --> Vault
    Runner --> Registry
    Services --> Metrics

    Services -.->|Internal DNS| Services
    Services -.->|Pub/Sub| Brokers
```

### Contratos de API m√≠nimos (Deploy Lifecycle)

### Iniciar servi√ßo

```json
// POST /services/{id}/start

// Request
{
    "image": "[ghcr.io/org/api:1.2.3](http://ghcr.io/org/api:1.2.3)",
    "env": [
        {
            "key": "NODE_ENV",
            "value": "prod"
        }
    ],
    "resources": {
        "cpu": "500m",
        "memory": "512Mi"
    },
    "health": {
        "path": "/health",
        "timeoutSec": 2,
        "intervalSec": 5
    }
}

// Response
{
    "deploymentId": "dep_123",
    "status": "starting"
}
```

### Health check

```json
// GET /deployments/{deploymentId}/health

// Response
{
  "status": "healthy",
  "checks": [
    {
      "name": "http",
      "status": "pass",
      "latencyMs": 45
    }
  ]
}
```

### Escalonar servi√ßo

```json
// POST /services/{id}/scale

// Request
{
    "policy": {
        "type": "cpu",
        "target": 70,
        "min": 2,
        "max": 8,
        "cooldownSec": 60
    }
}

// Response
{
    "status": "accepted",
    "replicas": {
        "prev": 2,
        "desired": 4
    }
}
```

### Parar servi√ßo

```json
// POST /services/{id}/stop

// Request
{
    "drainTimeoutSec": 30
}

// Response
{
    "status": "stopping"
}
```

### Requisitos de seguran√ßa

- mTLS opt-in para tr√°fego service-to-service com rota√ß√£o autom√°tica de certificados
- RBAC por projeto/ambiente/servi√ßo, integrado ao Gateway e Control Plane
- Network policies deny-by-default com templates para habilitar rotas necess√°rias
- Segredos: integra√ß√£o Vault-compatible, KMS para criptografia em repouso, auditoria de acesso

## Developer Tools & CLI

### Capsule CLI

**Descri√ß√£o**

CLI completa para gerenciamento de recursos, desenvolvimento local e automa√ß√£o de workflows

**Comandos principais**

```bash
# Auth & Setup
capsule auth login
capsule auth logout
capsule context set <project>

# Development
capsule init                    # Inicializa projeto com capsule.yaml
capsule dev                      # Ambiente de desenvolvimento local
capsule validate                 # Valida configura√ß√£o

# Deployment
capsule deploy [--env <env>]    # Deploy do projeto
capsule rollback <deployment-id>
capsule preview create --branch <branch>

# Resources
capsule services list
capsule services logs <service-id> [--follow]
capsule services exec <service-id> -- <command>
capsule services port-forward <service-id> <local>:<remote>

# Brokers
capsule broker create <type> [--plan <plan>]
capsule broker bind <broker-id> <service-id>

# Secrets & Config
capsule secrets set KEY=value
capsule secrets list
capsule config edit [--env <env>]

# Monitoring
capsule status
capsule metrics <service-id>
capsule events [--follow]
```

### Code Generators

**Descri√ß√£o**

Generators para scaffolding r√°pido seguindo best practices

**Generators dispon√≠veis**

```bash
# Nx Generators customizados
nx g @capsule/plugin:service <name>        # Novo microservi√ßo
nx g @capsule/plugin:context <name>        # Novo bounded context DDD
nx g @capsule/plugin:feature <name>        # Nova feature FSD no frontend
nx g @capsule/plugin:component <name>      # Componente no design system

# Templates inclusos
- Dockerfile otimizado multi-stage
- GitHub Actions workflow para preview envs
- Configura√ß√£o de health checks
- Network policies templates
- Capsule.yaml com best practices
```

**Exemplo de generator de servi√ßo**

```bash
$ nx g @capsule/plugin:service payment

CREATE apps/service-payment/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main.ts
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts
‚îÇ   ‚îî‚îÄ‚îÄ health/
‚îÇ       ‚îî‚îÄ‚îÄ health.controller.ts
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ capsule.yaml
‚îú‚îÄ‚îÄ project.json
‚îî‚îÄ‚îÄ tsconfig.json

CREATE libs/contexts/payment/
‚îú‚îÄ‚îÄ domain/
‚îú‚îÄ‚îÄ application/
‚îî‚îÄ‚îÄ infrastructure/

UPDATE nx.json
UPDATE tsconfig.base.json
```

### Local Development Tools

**Capsule Dev Server**

- Emula√ß√£o local do ambiente Capsule
- Hot reload com watchers
- Service discovery local
- Logs agregados
- Mock de brokers

```bash
# Inicia ambiente local
capsule dev

# Output
üöÄ Capsule Dev Server
   Portal:    [http://localhost:3000](http://localhost:3000)
   API:       [http://localhost:4000](http://localhost:4000)
   Services:
     - api:     [http://localhost:5001](http://localhost:5001) [healthy]
     - worker:  running [healthy]
   Brokers:
     - redis:   [localhost:6379](http://localhost:6379)
   Watching for changes...
```

### IDE Extensions

**VS Code Extension**

- Syntax highlighting para capsule.yaml
- Autocomplete de configura√ß√µes
- Valida√ß√£o em tempo real
- Comandos integrados na command palette
- Visualiza√ß√£o de logs inline
- Debug configuration autom√°tica

**Features da extens√£o**

- IntelliSense para capsule.yaml
- Snippets para configura√ß√µes comuns
- Integra√ß√£o com Capsule CLI
- Port forwarding visual
- Log streaming no terminal integrado

### Migration Tools

**Importadores autom√°ticos**

```bash
# Importa de outras plataformas
capsule import heroku <app-name>
capsule import vercel <project-id>
capsule import docker-compose <file>
capsule import k8s <manifests-dir>

# Valida migra√ß√£o
capsule import --dry-run <source>

# Exporta configura√ß√£o
capsule export --format <helm|terraform|k8s>
```

### Observability Tools

**Debug & Profiling**

```bash
# Debug remoto
capsule debug <service-id> --port 9229

# Profiling
capsule profile cpu <service-id> --duration 30s
capsule profile memory <service-id>
capsule profile trace <request-id>

# An√°lise de custos
capsule cost analyze [--last 30d]
capsule cost forecast
```

### CI/CD Integrations

**GitHub Actions**

```yaml
# .github/workflows/capsule.yml
- uses: capsule/setup-cli@v1
- uses: capsule/preview-env@v1
  with:
    auto-destroy: true
    ttl: 24h
```

**GitLab CI**

```yaml
# .gitlab-ci.yml
include:
  - remote: [https://capsule.io/ci/gitlab.yml](https://capsule.io/ci/gitlab.yml)

preview:
  extends: .capsule-preview
  environment:
    name: preview/$CI_MERGE_REQUEST_IID
    url: [https://$CI_MERGE_REQUEST_IID.preview.capsule.io](https://$CI_MERGE_REQUEST_IID.preview.capsule.io)
    on_stop: preview_stop
    auto_stop_in: 24 hours

preview_stop:
  extends: .capsule-preview-stop
  environment:
    name: preview/$CI_MERGE_REQUEST_IID
    action: stop
```

### SDK & Client Libraries

**Linguagens suportadas**

- TypeScript/JavaScript: `@capsule/sdk`
- Go: [`github.com/capsule/go-sdk`](http://github.com/capsule/go-sdk)
- Python: `capsule-sdk`
- Rust: `capsule-rs`

**Exemplo TypeScript SDK**

```tsx
import { CapsuleClient } from '@capsule/sdk'

const capsule = new CapsuleClient({
  apiKey: process.env.CAPSULE_API_KEY
})

// Deploy program√°tico
const deployment = await [capsule.services](http://capsule.services).deploy({
  image: '[ghcr.io/org/api:latest](http://ghcr.io/org/api:latest)',
  env: { NODE_ENV: 'production' },
  replicas: 2
})

// Monitoring
const metrics = await capsule.metrics.query({
  service: 'api',
  metric: 'request_rate',
  period: '1h'
})

// Gerenciar secrets
await capsule.secrets.set('DATABASE_URL', 'postgres://...')

// Criar preview environment
const preview = await capsule.previews.create({
  branch: 'feature-xyz',
  ttl: '24h'
})
```

### Development Workflow Automation

**Capsule Workflows**

```yaml
# .capsule/workflows/release.yaml
name: Production Release
on:
  push:
    tags: [v*]

steps:
  - validate:
      config: capsule.yaml

  - test:
      services: [api, worker]

  - deploy:
      environment: production
      strategy: blue-green
      health-wait: 5m

  - notify:
      slack: deployments
```

### Impacto nos MVPs

**MVP1 deve incluir:**

- CLI b√°sica (auth, deploy, logs)
- Generator de projeto inicial
- Capsule.yaml schema

**MVP2 deve incluir:**

- VS Code extension
- Generators avan√ßados
- GitHub Actions integration

**MVP3 deve incluir:**

- SDKs completos
- Migration tools
- Workflow automation

## Development Roadmap

### Milestones (MVP1 ‚Üí MVP3)

### MVP1 (Base oper√°vel)

- **Entreg√°veis**: Deploy one-click (1), Service Discovery (3), Config & Secrets (5), Observability minimal (6)
- **Crit√©rios de aceita√ß√£o**: Onboarding p50 < 15min; deploy p50 < 60s; logs/health dispon√≠veis; DNS interno funcional com pol√≠ticas b√°sicas
- **T-shirt sizing (epics)**: Control Plane b√°sico (L), Deploy Runner (M), Registry integration (S), Logs/Health (M)

### MVP2 (Fluxo de entrega segura)

- **Entreg√°veis**: Preview Envs (7), Blue/Green & Canary (2), Network Policies GUI (9)
- **Crit√©rios de aceita√ß√£o**: 80% dos PRs com preview; rollback < 30s; pol√≠ticas aplic√°veis via UI sem YAML
- **T-shirt sizing**: Preview orchestration (M), Traffic manager (M), GUI policies (S)

### MVP3 (Confiabilidade e portabilidade)

- **Entreg√°veis**: Managed Broker (4), Portable Export/Import (10), Autoscaling (8)
- **Crit√©rios de aceita√ß√£o**: Provisionamento broker p90 < 3min; export/import idempotente validado; redu√ß√£o de custo via autoscaling ‚â• 20%
- **T-shirt sizing**: Broker provisioner (L), IaC exporter/importer (M), Autoscaler (M)

### Epics/tickets sugeridos (exemplos)

- CP-001 Control Plane: modelo declarativo de app/servi√ßo (M)
- CP-002 Deploy Runner: orquestra√ß√£o e lifecycle (M)
- NET-010 Service Discovery e DNS interno (M)
- SEC-020 RBAC e policies deny-by-default (M)
- OBS-030 Logs/traces/m√©tricas m√≠nimas (M)
- REL-040 Canary/Blue-Green por rota (M)
- PRE-050 Preview environments (M)
- BRK-060 Broker provisioner (L)
- EXP-070 Export/Import YAML/Helm/Terraform (M)
- GUI-080 Network Policies GUI (S)

## Logical Dependency Chain

1. Modelo declarativo de App/Servi√ßo
2. Integra√ß√£o com Registry (auth/secret)
3. Control Plane b√°sico (start/stop/health)
4. Deploy Runner/Workers
5. Service Discovery + DNS interno
6. Observability m√≠nima (logs/metrics/trace)
7. RBAC + Network policies deny-by-default
8. Preview orchestration (depende 1‚Äì7)
9. Traffic manager (Blue/Green/Canary) (depende 6‚Äì7)
10. Autoscaling (depende 6)
11. Broker provisioner (depende 7)
12. Export/Import IaC (depende 1)

### Blockers t√©cnicos

- Isolamento multi-tenant de broker (namespaces/vhosts, rate-limits)
- Controle de custos para previews (quotas, TTL, hiberna√ß√£o/cold-start)

## Risks and Mitigations

### Isolamento de brokers gerenciados

**Mitiga√ß√£o**: vhosts/virtual clusters por tenant, namespaces, TLS obrigat√≥rio, rate-limits e quotas por conex√£o/throughput

### Custo de previews

**Mitiga√ß√£o**: TTL obrigat√≥rio, hiberna√ß√£o autom√°tica fora do hor√°rio, or√ßamentos por projeto e autoscaling m√≠nimo = 0 quando poss√≠vel

### Vendor lock-in

**Mitiga√ß√£o**: Export/Import para Kubernetes/Helm/Terraform, evitar recursos propriet√°rios no data plane

### Complexidade de mesh

**Mitiga√ß√£o**: mesh-lite opt-in (mTLS, retries, timeouts) e escopo controlado

### Seguran√ßa de segredos

**Mitiga√ß√£o**: Vault-compatible + KMS, rota√ß√£o autom√°tica, auditoria, zero exposi√ß√£o em logs

### Limita√ß√µes WebSocket/Ingress

**Mitiga√ß√£o**: keepalives documentados, timeouts ajust√°veis, rotas diretas opcionais

## Appendix

## C√≥digo de Exemplo Completo

### Frontend com Zustand

```tsx
// features/deploy-app/model/useDeployStore.ts
import { create } from 'zustand';

type State = {
  lastDeployment?: string;
  setLastDeployment: (id: string) => void;
};

export const useDeployStore = create<State>((set) => ({
  lastDeployment: undefined,
  setLastDeployment: (id) => set({ lastDeployment: id }),
}));
```

### Endpoints de API

```json
// POST /auth/signup
{
  "email": "[user@example.com](mailto:user@example.com)",
  "password": "SecurePass123!",
  "name": "John Doe",
  "organizationName": "Acme Corp"
}

// POST /services/{id}/deployments
{
  "strategy": "canary",
  "image": "[ghcr.io/org/api:v2](http://ghcr.io/org/api:v2)",
  "canaryPercent": 10
}
```

### Exemplo de declara√ß√£o YAML

```yaml
app: myapp
services:
  - name: api
    image: [ghcr.io/acme/api:1.2.3](http://ghcr.io/acme/api:1.2.3)
    protocol: http
    port: 8080
    env:
      - NODE_ENV=prod
    scalingPolicy:
      type: cpu
      target: 70
      min: 2
      max: 5
```

## Notas Finais

- Stateful (bancos de dados) fora de escopo
- Redis somente pub/sub
- Tr√°fego intra-plataforma incluso

### Arquitetura de Implementa√ß√£o

### Backend (Monorepo NestJS/Nx ‚Äî Domain-Driven Hexagon)

- Monorepo com Nx aplicando DDD + Arquitetura Hexagonal
- Bounded contexts em libs/contexts/\*
- Camadas:
  - **Domain**: entities, value objects, aggregates, domain events
  - **Application**: use cases (servi√ßos de aplica√ß√£o), ports (interfaces), DTOs
  - **Infrastructure**: adapters (HTTP, message), repositories, mapeamentos
- API Gateway como BFF para o Portal e fachada para servi√ßos
- Microservi√ßos por contexto de dom√≠nio
- Ports & Adapters para RabbitMQ, Redis, PostgreSQL (e outros providers)

### Estrutura macro do monorepo

```
monorepo/
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ api-gateway/        # NestJS API Gateway (BFF)
‚îÇ   ‚îú‚îÄ‚îÄ service-auth/       # NestJS Microservi√ßo (contexto Auth)
‚îÇ   ‚îú‚îÄ‚îÄ service-deploy/     # NestJS Microservi√ßo (contexto Deploy)
‚îÇ   ‚îú‚îÄ‚îÄ service-billing/    # NestJS Microservi√ßo (contexto Billing)
‚îÇ   ‚îî‚îÄ‚îÄ portal/             # Vite + React + Tailwind
‚îú‚îÄ‚îÄ libs/
‚îÇ   ‚îú‚îÄ‚îÄ contexts/           # Backend DDD Contexts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ deploy/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ billing/
‚îÇ   ‚îú‚îÄ‚îÄ shared/             # Compartilhado Full-Stack
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/            # DTOs TypeScript (backend/frontend)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types/          # Tipos compartilhados
‚îÇ   ‚îî‚îÄ‚îÄ ui/                 # Frontend components library
‚îÇ       ‚îî‚îÄ‚îÄ components/
‚îú‚îÄ‚îÄ nx.json
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.base.json
```

### Exemplo de bounded context completo (Deploy)

```
libs/contexts/deploy/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AppEntity.ts
‚îÇ   ‚îú‚îÄ‚îÄ value-objects/
‚îÇ   ‚îî‚îÄ‚îÄ events/
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ use-cases/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ CreateDeployUseCase.ts
‚îÇ   ‚îú‚îÄ‚îÄ ports/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DeployRepository.port.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ContainerRegistry.port.ts
‚îÇ   ‚îî‚îÄ‚îÄ dtos/
‚îî‚îÄ‚îÄ infrastructure/
    ‚îú‚îÄ‚îÄ adapters/
    ‚îÇ   ‚îú‚îÄ‚îÄ NestDeployController.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PostgresDeployRepository.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ RabbitMQEventPublisher.ts
    ‚îî‚îÄ‚îÄ module.ts
```

### Exemplo de bounded context Auth

```
libs/contexts/auth/
‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îú‚îÄ‚îÄ entities/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.entity.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Organization.entity.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Member.entity.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ApiKey.entity.ts
‚îÇ   ‚îú‚îÄ‚îÄ value-objects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Email.vo.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Role.vo.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Permission.vo.ts
‚îÇ   ‚îî‚îÄ‚îÄ events/
‚îÇ       ‚îú‚îÄ‚îÄ UserCreated.event.ts
‚îÇ       ‚îú‚îÄ‚îÄ OrganizationCreated.event.ts
‚îÇ       ‚îî‚îÄ‚îÄ MemberInvited.event.ts
‚îú‚îÄ‚îÄ application/
‚îÇ   ‚îú‚îÄ‚îÄ use-cases/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignUpUseCase.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignInUseCase.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RefreshTokenUseCase.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateApiKeyUseCase.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InviteMemberUseCase.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UpdateRoleUseCase.ts
‚îÇ   ‚îú‚îÄ‚îÄ ports/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.port.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TokenService.port.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ EmailService.port.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ OAuthProvider.port.ts
‚îÇ   ‚îî‚îÄ‚îÄ dtos/
‚îÇ       ‚îú‚îÄ‚îÄ SignIn.dto.ts
‚îÇ       ‚îú‚îÄ‚îÄ SignUp.dto.ts
‚îÇ       ‚îî‚îÄ‚îÄ CreateApiKey.dto.ts
‚îî‚îÄ‚îÄ infrastructure/
    ‚îú‚îÄ‚îÄ adapters/
    ‚îÇ   ‚îú‚îÄ‚îÄ NestAuthController.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ PostgresUserRepository.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ JwtTokenService.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ GitHubOAuthProvider.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ SendGridEmailService.ts
    ‚îú‚îÄ‚îÄ guards/
    ‚îÇ   ‚îú‚îÄ‚îÄ JwtAuthGuard.ts
    ‚îÇ   ‚îú‚îÄ‚îÄ ApiKeyGuard.ts
    ‚îÇ   ‚îî‚îÄ‚îÄ RbacGuard.ts
    ‚îî‚îÄ‚îÄ module.ts
```
